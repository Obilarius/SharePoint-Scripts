<!-- <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script> -->

<!-- FÃ¼r Sharepoint -->
<script src="Documents/jquery-3.3.1.min.js"></script> 

<div id="webradio"> 
	<audio id="webradio-audio" preload="none">
		<source src="" type="audio/mpeg">
	</audio>
	<div id="webradio-audio-controls">
		<img class="disabled" id="playbutton" src="http://intranet/PublishingImages/webradio_play.png" width="24" alt="Play" title="Play" onclick="play_wr()">
		
		<img class="disabled" id="stopbutton" src="http://intranet/PublishingImages/webradio_pause.png" width="24" alt="Pause" disabled="" onclick="stop_wr()">
		
		<input id="vol-control" style="border: 0" type="range" min="0" max="100" step="1" oninput="SetVolume(this.value)" onchange="SetVolume(this.value)">
	</div>
	<p id="aktuellerTitel">Aktueller Titel: <span id="marquee" class="marquee"><span class="songtitle">kein Songtitle</span></span></p>

	<div id="radioStations"></div>		
</div>

<script>
	$(function(){
	    $.getJSON("http://radio.arges.local:8000/status-json.xsl", function( data ) {
			var streams = data.icestats.source

			$("#radioStations").html("");

			streams.sort(SortByName);

			$.each( streams, function( key, val ) {
				let sn = val.server_name;
				let url = val.listenurl;
				let genre = val.genre;

				let div = '<div class="btn" data-url="'+url+'" data-name="'+sn+'" onclick="changeSender(this)"><img src="data:image/gif;base64,R0lGODlhCAAMAIABAOeqGP///yH5BAEKAAEALAAAAAAIAAwAAAINjI+pywgPHJSPxoZZAQA7" align="top">'+ toTitleCase(sn) +'</div>';

				$("#radioStations").append(div);

			});
		}); 
	});

	function SortByName(a, b){
		var aName = a.server_name.toLowerCase();
		var bName = b.server_name.toLowerCase(); 
		return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
	}

	function toTitleCase(str) {
	    return str.replace(/\w\S*/g, function(txt){
	        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
	    });
	}
	
	function play_wr(){
		var audio = document.getElementById("webradio-audio");
		var playbutton = document.getElementById("playbutton");
		var stopbutton = document.getElementById("stopbutton");
		audio.load(); // auch gebufferte Reste entfernen
		var play = audio.play();

		playbutton.removeAttribute('title');
		playbutton.setAttribute('disabled','disabled');
		stopbutton.removeAttribute('disabled');
		stopbutton.setAttribute('title','Pause');

		playbutton.classList.add("disabled");
		stopbutton.classList.remove("disabled");
	}

	function stop_wr(){
		var playbutton = document.getElementById("playbutton");
		var stopbutton = document.getElementById("stopbutton");
		document.getElementById("webradio-audio").load();

		playbutton.removeAttribute('disabled');
		playbutton.setAttribute('title','Play');
		stopbutton.removeAttribute('title');
		stopbutton.setAttribute('disabled','disabled');

		playbutton.classList.remove("disabled");
		stopbutton.classList.add("disabled");
	}
	
	function SetVolume(val) {
		document.getElementById('webradio-audio').volume = val / 100;
	}	

	if (document.getElementById('webradio-audio')) {
	 	document.getElementById("webradio-audio").volume = 0.5;	
	}

	function changeSender(btn) {
		var senderSrc = btn.getAttribute('data-url');
		var activeSender = $(".activeSender").first();

		if (activeSender[0] == btn) return;

		$(".btn").removeClass("activeSender")
		$(btn).addClass("activeSender");

		$("#webradio-audio > source").attr("src",senderSrc);
		play_wr();
		
		setSongTitle();

		setInterval(function() {
			console.log("Songtitle refresh");
			setSongTitle()
		}, 4000);

		// var interval = setIntervalAndExecute(setSongTitle(), 4000);
	}
	
	function setSongTitle () {
		$.getJSON("http://radio.arges.local:8000/status-json.xsl", function( data ) {
			var streams = data.icestats.source

			var activeSender = $(".activeSender").first();
			activeSender = activeSender[0];

			activeID = activeSender.id
			activeName = activeSender.getAttribute('data-name');

			$.each( streams, function( key, val ) {
				if (val.server_name == activeName) {
					$(".songtitle").html(val.title);
				}
			});
		}); 
	}


	function setIntervalAndExecute(fn, t) {
	    // fn();
	    return(setInterval(fn, t));
	}

</script>

<style type="text/css">
#webradio {
	font-size:11px;
	font-family:Verdana, Geneva, sans-serif !important; 
	color:#004785;

	width: 300px;
	overflow: hidden;
}

#webradio-audio-controls {
	padding: 10px 10px 0 10px;
}

#aktuellerTitel {
	padding: 0px 10px;
	font-style: italic;
}

#webradio-audio-controls > #vol-control {
	padding: 0;
	width: 200px;
	height: 30px;
}

#webradio #playbutton, #webradio #stopbutton  {
    cursor: pointer;
    padding: 2px 5px;
    border: 1px solid #888;
    border-radius: 5px;
}

.disabled {
    opacity: .4;
    cursor: default !important;
    background: transparent;}

.btn {
	cursor: pointer;
	padding: 2px 10px;
	
}

.activeSender {
	background: lightgrey;
	font-weight: bold;
}


.marquee {
	width: 80%;
	white-space: nowrap;
	overflow: hidden;
	margin: auto;
	/* hier evtl. noch font-size, color usw. */
}

.marquee span {
	display: inline-block;
	padding-left: 100%;
	animation: marquee 10s linear infinite;
}

/* Make it move */
@keyframes marquee {
	0%   { transform: translateX(0); }
	100% { transform: translateX(-100%); }
}
</style>
